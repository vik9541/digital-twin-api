name: Deploy Personal Assistant Bot

on:
  push:
    branches: [main]
    paths:
      - 'bots/personal-assistant-bot/**'
  pull_request:
    branches: [main]
  schedule:
    # Синхронизация каждый день в 6:00 UTC (9:00 МСК)
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  BOT_PATH: bots/personal-assistant-bot

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ env.BOT_PATH }}/requirements.txt'
      
      - name: Install dependencies
        run: |
          cd ${{ env.BOT_PATH }}
          pip install -r requirements.txt
      
      - name: Check syntax
        run: |
          cd ${{ env.BOT_PATH }}
          python -m py_compile main.py
          python -m py_compile handlers/*.py
          python -m py_compile services/*.py
      
      - name: Run migration check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cd ${{ env.BOT_PATH }}
          python scripts/check_migrations.py

  sync-specs:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd ${{ env.BOT_PATH }}
          pip install httpx python-dotenv
      
      - name: Sync specs from documentation repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ${{ env.BOT_PATH }}
          python -c "
          import asyncio
          import os
          os.environ['GITHUB_SPECS_REPO'] = 'vik9541/super-brain-digital-twin'
          from services.github_sync import get_github_sync
          async def main():
              sync = get_github_sync()
              await sync.sync_specs()
          asyncio.run(main())
          "
      
      - name: Commit synced files
        run: |
          cd ${{ env.BOT_PATH }}
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add specs/ docs/
          git diff --staged --quiet || git commit -m "sync: обновление ТЗ и документации"
          git push

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ADMIN_ID: ${{ secrets.TELEGRAM_ADMIN_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_ADMIN_ID" ]; then
            STATUS="${{ needs.test.result }}"
            if [ "$STATUS" == "success" ]; then
              EMOJI="✅"
              TEXT="Bot CI passed"
            else
              EMOJI="❌"
              TEXT="Bot CI failed"
            fi
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_ADMIN_ID}" \
              -d text="${EMOJI} ${TEXT}%0A%0ACommit: ${GITHUB_SHA:0:7}%0ABranch: ${GITHUB_REF_NAME}%0AEvent: ${GITHUB_EVENT_NAME}" \
              -d parse_mode="HTML" || true
          fi
